name: Community Management

on:
  issues:
    types: [opened, labeled]
  pull_request_target:
    types: [opened, labeled]
  issue_comment:
    types: [created]

permissions:
  issues: write
  pull-requests: write

jobs:
  welcome:
    name: Welcome New Contributors
    runs-on: ubuntu-latest
    if: github.event.action == 'opened'
    steps:
      - name: Welcome first-time contributors
        uses: actions/first-interaction@v1
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          issue-message: |
            ğŸ‘‹ Welcome to AI Memory Module! Thanks for opening your first issue.

            A maintainer will review your issue soon. In the meantime:
            - Check out our [Contributing Guidelines](https://github.com/Hidden-History/ai-memory/blob/main/CONTRIBUTING.md)
            - Join the discussion in [GitHub Discussions](https://github.com/Hidden-History/ai-memory/discussions)
            - Star the repo if you find it useful â­

            Please ensure you've filled out the issue template completely to help us assist you faster.
          pr-message: |
            ğŸ‰ Thanks for your first pull request to AI Memory Module!

            A maintainer will review your PR soon. Here's what happens next:
            1. Automated tests will run (check the status above)
            2. A maintainer will review your code
            3. You may be asked to make changes
            4. Once approved, your PR will be merged ğŸš€

            **Quick reminders:**
            - Make sure all tests pass
            - Update documentation if needed
            - Link the related issue with `Fixes #XXX`

            Thanks for contributing! ğŸ™

  auto-label-component:
    name: Auto-label by Component
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request_target'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Label based on changed files
        uses: actions/labeler@v5
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          configuration-path: .github/labeler.yml
          sync-labels: true

  auto-label-size:
    name: Label PR Size
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request_target'
    steps:
      - name: Add size label
        uses: codelytv/pr-size-labeler@v1
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          xs_label: 'size: xs'
          xs_max_size: 10
          s_label: 'size: s'
          s_max_size: 100
          m_label: 'size: m'
          m_max_size: 500
          l_label: 'size: l'
          l_max_size: 1000
          xl_label: 'size: xl'
          fail_if_xl: false
          message_if_xl: >
            This PR is very large. Consider breaking it into smaller PRs for easier review.
            If this is unavoidable, please explain why in the PR description.

  check-linked-issue:
    name: Check Linked Issue
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request_target'
    steps:
      - name: Verify issue link
        uses: hattan/verify-linked-issue-action@v1.2.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          message: |
            âš ï¸ This PR doesn't appear to be linked to an issue.

            Please link it by adding one of these to your PR description:
            - `Fixes #123`
            - `Closes #123`
            - `Resolves #123`

            If this PR doesn't fix a specific issue, explain why in the description.

  triage-notify:
    name: Notify on New Issues
    runs-on: ubuntu-latest
    if: github.event_name == 'issues' && github.event.action == 'opened'
    steps:
      - name: Add needs-triage label
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['status: needs-triage']
            });

      - name: Comment with triage info
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueLabels = context.payload.issue.labels.map(l => l.name);

            // Only comment if it's a bug report
            if (issueLabels.includes('type: bug')) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `Thanks for reporting this bug! ğŸ›

A maintainer will triage this issue within 2-3 business days.

**In the meantime:**
- Check if the health check passes: \`python3 scripts/health-check.py\`
- Review [TROUBLESHOOTING.md](https://github.com/Hidden-History/ai-memory/blob/main/TROUBLESHOOTING.md)
- Check [existing issues](https://github.com/Hidden-History/ai-memory/issues) for similar problems

If you find a workaround, please share it here to help others! ğŸ™`
              });
            }
