# AI Code Review Pipeline (Ollama-Only)
# Uses Ollama Cloud API for all AI operations
# Access controlled: Only Hidden-History can trigger @claude
#
# API Provider:
#   - OLLAMA_API_KEY: Ollama Cloud (kimi-k2.5:cloud for review, llama3.3:70b for labeling)
#
# Triggers:
#   - @claude: Quick assist/analysis on issues or PRs
#   - @ai-review: Full code review (for PRs)
#
# Documentation: oversight/plans/GITHUB-SOURCE-OF-TRUTH.md

name: AI Code Review Pipeline

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened]

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  access-control:
    name: Check Authorization
    runs-on: ubuntu-latest
    if: contains(github.event.comment.body, '@claude') || contains(github.event.comment.body, '@ai-review')
    outputs:
      authorized: ${{ steps.check.outputs.authorized }}
      trigger_type: ${{ steps.check.outputs.trigger_type }}
      is_pr: ${{ steps.check.outputs.is_pr }}
    steps:
      - name: Check if user is authorized
        id: check
        run: |
          ALLOWED_USERS="Hidden-History"
          ACTOR="${{ github.actor }}"
          echo "Checking authorization for: $ACTOR"

          if echo "$ALLOWED_USERS" | grep -qw "$ACTOR"; then
            echo "authorized=true" >> $GITHUB_OUTPUT
            echo "User $ACTOR is authorized"
          else
            echo "authorized=false" >> $GITHUB_OUTPUT
            echo "User $ACTOR is NOT authorized"
          fi

          if echo "${{ github.event.comment.body }}" | grep -q "@ai-review"; then
            echo "trigger_type=full-review" >> $GITHUB_OUTPUT
          else
            echo "trigger_type=assist" >> $GITHUB_OUTPUT
          fi

          if [ -n "${{ github.event.issue.pull_request }}" ]; then
            echo "is_pr=true" >> $GITHUB_OUTPUT
          else
            echo "is_pr=false" >> $GITHUB_OUTPUT
          fi

      - name: Post unauthorized message
        if: steps.check.outputs.authorized == 'false'
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: 'Sorry @${{ github.actor }}, you are not authorized to trigger the AI assistant.\n\nOnly repository maintainers can use this feature.'
            });

  ai-review:
    name: AI Review (Ollama)
    needs: access-control
    if: needs.access-control.outputs.authorized == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      # TECH-DEBT-090 Task 2: Validate API credentials before making any API calls
      - name: Validate API credentials
        env:
          OLLAMA_API_KEY: ${{ secrets.OLLAMA_API_KEY }}
        run: |
          if [ -z "$OLLAMA_API_KEY" ]; then
            echo "::error::OLLAMA_API_KEY secret is not configured"
            exit 1
          fi
          echo "âœ“ API key validation passed"

      # TECH-DEBT-090 Tasks 4 & 8: Diff is read only once to avoid redundant GitHub API calls.
      # If future jobs need diff access, use GitHub Actions outputs with secure delimiters
      # (e.g., EOF_$(date +%s%N)_${RANDOM}) instead of multiple gh pr diff calls.
      - name: Get context for review
        id: context
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          IS_PR="${{ needs.access-control.outputs.is_pr }}"

          ISSUE_NUMBER="${{ github.event.issue.number }}"
          ISSUE_TITLE="${{ github.event.issue.title }}"
          ISSUE_BODY=$(gh issue view $ISSUE_NUMBER --json body -q '.body' 2>/dev/null | head -100 || echo "")

          if [ "$IS_PR" = "true" ]; then
            gh pr diff $ISSUE_NUMBER > /tmp/diff.txt 2>/dev/null || echo "No diff available" > /tmp/diff.txt
          else
            echo "" > /tmp/diff.txt
          fi

          echo "$ISSUE_TITLE" > /tmp/issue_title.txt
          echo "$ISSUE_BODY" > /tmp/issue_body.txt
          echo "${{ github.event.comment.body }}" > /tmp/comment.txt

          echo "Context gathered for issue #$ISSUE_NUMBER"

      # TECH-DEBT-090: Hardened AI analysis with secret redaction, JSON escaping, and retry logic
      - name: AI Analysis via Ollama Cloud
        id: ollama
        env:
          OLLAMA_API_KEY: ${{ secrets.OLLAMA_API_KEY }}
        run: |
          ISSUE_TITLE=$(cat /tmp/issue_title.txt)
          ISSUE_BODY=$(cat /tmp/issue_body.txt | head -50)
          USER_REQUEST=$(cat /tmp/comment.txt)
          IS_PR="${{ needs.access-control.outputs.is_pr }}"

          # TECH-DEBT-090 Task 5: Read and redact potential secrets from diff
          DIFF_RAW=$(cat /tmp/diff.txt | head -300)

          # TECH-DEBT-090 Task 5b: Skip AI review if diff touches sensitive files
          if echo "$DIFF_RAW" | grep -qE '^\+\+\+ b/.*(\.env|\.env\.|credentials|\.pem|\.key|id_rsa|\.p12|\.pfx)'; then
            echo "::warning::Diff contains changes to sensitive files â€” skipping AI review for safety"
            echo "review_ready=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          DIFF_FILTERED=$(echo "$DIFF_RAW" | \
            sed -E 's/(api[_-]?key|password|secret|token|bearer|private[_-]?key|client[_-]?secret)[[:space:]]*[:=][[:space:]]*["\047]?[^"\047[:space:]]+["\047]?/\1=***REDACTED***/gI' | \
            sed -E 's/(AWS|GITHUB|ANTHROPIC|OPENAI|OLLAMA|OAUTH)[_-]?(SECRET|TOKEN|KEY|PASSWORD)[_A-Z]*[[:space:]]*[:=][[:space:]]*[^[:space:]]+/\1_\2=***REDACTED***/g' | \
            sed -E 's/"[a-zA-Z_]*([Ss]ecret|[Tt]oken|[Kk]ey|[Pp]assword)"[[:space:]]*:[[:space:]]*"[^"]+"/"\1":"***REDACTED***"/g')

          # TECH-DEBT-090 Task 1: Build JSON payload with proper escaping using jq
          if [ "$IS_PR" = "true" ] && [ -s /tmp/diff.txt ]; then
            PAYLOAD=$(jq -n \
              --arg title "$ISSUE_TITLE" \
              --arg body "$ISSUE_BODY" \
              --arg diff "$DIFF_FILTERED" \
              --arg request "$USER_REQUEST" \
              '{
                "model": "kimi-k2.5:cloud",
                "messages": [{
                  "role": "user",
                  "content": ("You are an AI code reviewer. Analyze this PR and respond to the request.\n\n" +
                    "PR Title: " + $title + "\n\n" +
                    "PR Description: " + $body + "\n\n" +
                    "Code Changes:\n" + $diff + "\n\n" +
                    "User Request: " + $request + "\n\n" +
                    "Focus on: bugs, security, edge cases, improvements. Format in markdown.")
                }],
                "stream": false
              }')
          else
            PAYLOAD=$(jq -n \
              --arg title "$ISSUE_TITLE" \
              --arg body "$ISSUE_BODY" \
              --arg request "$USER_REQUEST" \
              '{
                "model": "kimi-k2.5:cloud",
                "messages": [{
                  "role": "user",
                  "content": ("You are an AI assistant for GitHub issues. Analyze and respond.\n\n" +
                    "Issue Title: " + $title + "\n\n" +
                    "Issue Description: " + $body + "\n\n" +
                    "User Request: " + $request + "\n\n" +
                    "If bug report: analyze root cause, suggest fix, identify affected files. Format in markdown.")
                }],
                "stream": false
              }')
          fi

          # TECH-DEBT-090 Task 3: Retry logic with exponential backoff and error handling
          echo "Calling Ollama Cloud API..."
          REVIEW_READY=false

          for attempt in 1 2 3; do
            echo "API call attempt $attempt/3..."

            # -s: silent, no -f: let HTTP errors return body for diagnosis
            # || true: prevent bash -e from aborting on curl timeout (exit 28)
            RESPONSE=$(curl -s --max-time 120 \
              -w "\n%{http_code}" \
              https://ollama.com/api/chat \
              -H "Authorization: Bearer $OLLAMA_API_KEY" \
              -H "Content-Type: application/json" \
              -d "$PAYLOAD" 2>&1) || true

            HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
            BODY=$(echo "$RESPONSE" | sed '$d')

            # Handle curl timeout (empty or non-numeric HTTP code)
            if ! echo "$HTTP_CODE" | grep -qE '^[0-9]+$'; then
              echo "::warning::curl failed (timeout or network error) on attempt $attempt"
              HTTP_CODE=0
            fi

            echo "HTTP Status: $HTTP_CODE"

            # Success: HTTP 2xx
            if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ] 2>/dev/null; then
              echo "âœ“ API call succeeded (HTTP $HTTP_CODE)"

              REVIEW=$(echo "$BODY" | jq -r '.message.content // empty')

              if [ -n "$REVIEW" ]; then
                echo "$REVIEW" > /tmp/review.txt
                echo "review_ready=true" >> $GITHUB_OUTPUT
                echo "Review received: $(wc -c < /tmp/review.txt) chars"
                REVIEW_READY=true
                break
              else
                echo "::warning::No review content in response"
                echo "Raw response: $BODY"
              fi
            else
              echo "::warning::API call failed (HTTP $HTTP_CODE)"
              echo "Response: $BODY"

              # Don't retry client errors (4xx) â€” only retry server errors (5xx) and timeouts
              if [ "$HTTP_CODE" -ge 400 ] && [ "$HTTP_CODE" -lt 500 ] 2>/dev/null; then
                echo "::error::Client error (HTTP $HTTP_CODE) â€” not retrying"
                break
              fi
            fi

            # Retry with exponential backoff (except on last attempt)
            if [ $attempt -lt 3 ]; then
              BACKOFF=$((5 * (2 ** (attempt - 1))))
              echo "Retrying in ${BACKOFF}s..."
              sleep $BACKOFF
            fi
          done

          # Final status
          if [ "$REVIEW_READY" = false ]; then
            echo "::error::API call failed after 3 attempts"
            echo "review_ready=false" >> $GITHUB_OUTPUT
          fi

      - name: Post AI response
        if: steps.ollama.outputs.review_ready == 'true'
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const review = fs.readFileSync('/tmp/review.txt', 'utf8');
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: '## ðŸ¤– AI Analysis (Ollama kimi-k2.5:cloud)\n\n' + review + '\n\n---\n*Triggered by @${{ github.actor }}*'
            });

      - name: Post error message
        if: steps.ollama.outputs.review_ready != 'true'
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: '## âš ï¸ AI Review Failed\n\nCould not complete AI analysis. Check [workflow logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}).'
            });

  auto-label:
    name: Auto-Label PR
    needs: access-control
    if: needs.access-control.outputs.authorized == 'true' && needs.access-control.outputs.is_pr == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Validate API credentials
        id: validate-key
        env:
          OLLAMA_API_KEY: ${{ secrets.OLLAMA_API_KEY }}
        run: |
          if [ -z "$OLLAMA_API_KEY" ]; then
            echo "::warning::OLLAMA_API_KEY not configured â€” skipping auto-label"
            echo "has_key=false" >> $GITHUB_OUTPUT
          else
            echo "has_key=true" >> $GITHUB_OUTPUT
          fi

      # TECH-DEBT-090 Task 3: Hardened PR classification with retry logic
      - name: Classify PR type
        if: steps.validate-key.outputs.has_key == 'true'
        id: classify
        env:
          OLLAMA_API_KEY: ${{ secrets.OLLAMA_API_KEY }}
        run: |
          PR_TITLE="${{ github.event.issue.title }}"

          # Build JSON payload with proper escaping
          PAYLOAD=$(jq -n \
            --arg title "$PR_TITLE" \
            '{
              "model": "llama3.3:70b",
              "messages": [{
                "role": "user",
                "content": ("Classify this PR title as ONE of: bug, feature, docs, refactor, test, chore. Title: " + $title + ". Return ONLY the single word.")
              }],
              "stream": false
            }')

          # Retry logic with exponential backoff
          LABEL=""
          for attempt in 1 2 3; do
            echo "Classification attempt $attempt/3..."

            RESPONSE=$(curl -s --max-time 60 \
              https://ollama.com/api/chat \
              -H "Authorization: Bearer $OLLAMA_API_KEY" \
              -H "Content-Type: application/json" \
              -d "$PAYLOAD" 2>&1) || true

            # Extract label if successful
            LABEL=$(echo "$RESPONSE" | jq -r '.message.content // empty' 2>/dev/null | tr -d '[:space:]' | tr '[:upper:]' '[:lower:]')

            if [ -n "$LABEL" ]; then
              echo "âœ“ Classified as: $LABEL"
              echo "label=$LABEL" >> $GITHUB_OUTPUT
              break
            fi

            # Retry with backoff (except on last attempt)
            if [ $attempt -lt 3 ]; then
              BACKOFF=$((5 * (2 ** (attempt - 1))))
              echo "::warning::Classification failed, retrying in ${BACKOFF}s..."
              sleep $BACKOFF
            fi
          done

          if [ -z "$LABEL" ]; then
            echo "::warning::Failed to classify PR after 3 attempts"
            echo "label=" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: Apply label
        if: steps.validate-key.outputs.has_key == 'true' && steps.classify.outputs.label != ''
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const label = '${{ steps.classify.outputs.label }}'.trim().toLowerCase();
            const validLabels = ['bug', 'feature', 'docs', 'refactor', 'test', 'chore'];
            if (validLabels.includes(label)) {
              try {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  labels: ['type:' + label]
                });
                console.log('Applied label: type:' + label);
              } catch (e) {
                console.log('Could not apply label: ' + e.message);
              }
            }

  auto-triage-issue:
    name: Auto-Triage New Issue
    runs-on: ubuntu-latest
    if: >-
      github.event_name == 'issues' && github.event.action == 'opened'
      && !endsWith(github.actor, '[bot]')
      && github.actor != 'dependabot[bot]'
      && github.actor != 'github-actions[bot]'
    steps:
      - name: Validate API credentials
        id: validate-key
        env:
          OLLAMA_API_KEY: ${{ secrets.OLLAMA_API_KEY }}
        run: |
          if [ -z "$OLLAMA_API_KEY" ]; then
            echo "::warning::OLLAMA_API_KEY not configured â€” skipping auto-triage"
            echo "has_key=false" >> $GITHUB_OUTPUT
          else
            echo "has_key=true" >> $GITHUB_OUTPUT
            echo "âœ“ API key validation passed"
          fi

      - name: Gather issue context
        if: steps.validate-key.outputs.has_key == 'true'
        id: issue-context
        env:
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          echo "$ISSUE_TITLE" > /tmp/triage_title.txt
          printf '%s' "$ISSUE_BODY" | head -c 4000 > /tmp/triage_body.txt
          printf '%s' "$ISSUE_BODY" | head -c 200 > /tmp/triage_body_short.txt
          echo "Issue context saved"

      - name: Multi-model analysis (kimi-k2.5:cloud, deepseek-v3.1:671b-cloud, qwen3-coder-next:cloud)
        if: steps.validate-key.outputs.has_key == 'true'
        id: analysis
        continue-on-error: true
        env:
          OLLAMA_API_KEY: ${{ secrets.OLLAMA_API_KEY }}
        run: |
          ISSUE_TITLE=$(cat /tmp/triage_title.txt)
          ISSUE_BODY=$(cat /tmp/triage_body.txt)

          call_ollama() {
            local model="$1"
            local prompt="$2"
            local result=""
            for attempt in 1 2 3; do
              RESPONSE=$(curl -s --max-time 120 \
                -w "\n%{http_code}" \
                https://ollama.com/api/chat \
                -H "Authorization: Bearer $OLLAMA_API_KEY" \
                -H "Content-Type: application/json" \
                -d "$(jq -n --arg m "$model" --arg p "$prompt" \
                  '{"model":$m,"messages":[{"role":"user","content":$p}],"stream":false}')" \
                2>&1) || true
              HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
              BODY=$(echo "$RESPONSE" | sed '$d')
              if echo "$HTTP_CODE" | grep -qE '^[0-9]+$' && [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ] 2>/dev/null; then
                result=$(echo "$BODY" | jq -r '.message.content // empty')
                if [ -n "$result" ]; then echo "$result"; return 0; fi
              fi
              if echo "$HTTP_CODE" | grep -qE '^[0-9]+$' && [ "$HTTP_CODE" -ge 400 ] && [ "$HTTP_CODE" -lt 500 ] 2>/dev/null; then break; fi
              if [ $attempt -lt 3 ]; then sleep $((5 * (2 ** (attempt - 1)))); fi
            done
            echo "Analysis unavailable for this model"
            return 1
          }

          ANALYSIS_PROMPT=$(jq -n \
            --arg title "$ISSUE_TITLE" \
            --arg body "$ISSUE_BODY" \
            '"You are an AI assistant triaging a new GitHub issue for the AI Memory Module project. Analyze: 1) Issue type (bug/feature/question/docs) 2) Severity (critical/high/medium/low) 3) Affected components 4) Suggested next steps. Issue Title: " + $title + ". Issue Body: " + $body + ". Respond in concise markdown."'
          )

          echo "Running analysis with kimi-k2.5:cloud..."
          ANALYSIS_1=$(call_ollama "kimi-k2.5:cloud" "$ANALYSIS_PROMPT" || echo "Analysis unavailable for this model")
          echo "$ANALYSIS_1" > /tmp/analysis_kimi.txt

          echo "Running analysis with deepseek-v3.1:671b-cloud..."
          ANALYSIS_2=$(call_ollama "deepseek-v3.1:671b-cloud" "$ANALYSIS_PROMPT" || echo "Analysis unavailable for this model")
          echo "$ANALYSIS_2" > /tmp/analysis_deepseek.txt

          echo "Running analysis with qwen3-coder-next:cloud..."
          ANALYSIS_3=$(call_ollama "qwen3-coder-next:cloud" "$ANALYSIS_PROMPT" || echo "Analysis unavailable for this model")
          echo "$ANALYSIS_3" > /tmp/analysis_qwen.txt

          echo "Analysis complete for all 3 models"

      - name: Multi-model classification (llama3.3:70b, glm-5:cloud, qwen3.5:cloud)
        if: steps.validate-key.outputs.has_key == 'true'
        id: classify
        continue-on-error: true
        env:
          OLLAMA_API_KEY: ${{ secrets.OLLAMA_API_KEY }}
        run: |
          ISSUE_TITLE=$(cat /tmp/triage_title.txt)
          ISSUE_BODY_SHORT=$(cat /tmp/triage_body_short.txt)

          call_ollama() {
            local model="$1"
            local prompt="$2"
            local result=""
            for attempt in 1 2 3; do
              RESPONSE=$(curl -s --max-time 120 \
                -w "\n%{http_code}" \
                https://ollama.com/api/chat \
                -H "Authorization: Bearer $OLLAMA_API_KEY" \
                -H "Content-Type: application/json" \
                -d "$(jq -n --arg m "$model" --arg p "$prompt" \
                  '{"model":$m,"messages":[{"role":"user","content":$p}],"stream":false}')" \
                2>&1) || true
              HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
              BODY=$(echo "$RESPONSE" | sed '$d')
              if echo "$HTTP_CODE" | grep -qE '^[0-9]+$' && [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ] 2>/dev/null; then
                result=$(echo "$BODY" | jq -r '.message.content // empty')
                if [ -n "$result" ]; then echo "$result"; return 0; fi
              fi
              if echo "$HTTP_CODE" | grep -qE '^[0-9]+$' && [ "$HTTP_CODE" -ge 400 ] && [ "$HTTP_CODE" -lt 500 ] 2>/dev/null; then break; fi
              if [ $attempt -lt 3 ]; then sleep $((5 * (2 ** (attempt - 1)))); fi
            done
            echo "Analysis unavailable for this model"
            return 1
          }

          CLASSIFICATION_PROMPT=$(jq -n \
            --arg title "$ISSUE_TITLE" \
            --arg body "$ISSUE_BODY_SHORT" \
            '"Classify this GitHub issue as ONE of: bug, feature, question, enhancement, documentation. Title: " + $title + ". Body (first 200 chars): " + $body + ". Return ONLY the single word."'
          )

          echo "Classifying with llama3.3:70b..."
          LABEL_1=$(call_ollama "llama3.3:70b" "$CLASSIFICATION_PROMPT" || echo "")
          LABEL_1=$(echo "$LABEL_1" | tr -d '[:space:]' | tr '[:upper:]' '[:lower:]' | head -c 20)

          echo "Classifying with glm-5:cloud..."
          LABEL_2=$(call_ollama "glm-5:cloud" "$CLASSIFICATION_PROMPT" || echo "")
          LABEL_2=$(echo "$LABEL_2" | tr -d '[:space:]' | tr '[:upper:]' '[:lower:]' | head -c 20)

          echo "Classifying with qwen3.5:cloud..."
          LABEL_3=$(call_ollama "qwen3.5:cloud" "$CLASSIFICATION_PROMPT" || echo "")
          LABEL_3=$(echo "$LABEL_3" | tr -d '[:space:]' | tr '[:upper:]' '[:lower:]' | head -c 20)

          echo "Raw classifications: '$LABEL_1', '$LABEL_2', '$LABEL_3'"

          VALID_LABELS="bug feature question enhancement documentation"
          CONSENSUS_LABEL=""

          # Validate each label against allowed values
          validate_label() {
            local lbl="$1"
            for v in $VALID_LABELS; do
              if [ "$lbl" = "$v" ]; then echo "$lbl"; return 0; fi
            done
            echo ""
          }

          V1=$(validate_label "$LABEL_1")
          V2=$(validate_label "$LABEL_2")
          V3=$(validate_label "$LABEL_3")

          echo "Validated classifications: '$V1', '$V2', '$V3'"

          # Consensus: 2+ out of 3 models must agree
          if [ -n "$V1" ] && [ -n "$V2" ] && [ "$V1" = "$V2" ]; then
            CONSENSUS_LABEL="$V1"
          elif [ -n "$V1" ] && [ -n "$V3" ] && [ "$V1" = "$V3" ]; then
            CONSENSUS_LABEL="$V1"
          elif [ -n "$V2" ] && [ -n "$V3" ] && [ "$V2" = "$V3" ]; then
            CONSENSUS_LABEL="$V2"
          fi

          if [ -n "$CONSENSUS_LABEL" ]; then
            echo "Consensus label: $CONSENSUS_LABEL"
            echo "consensus_label=$CONSENSUS_LABEL" >> $GITHUB_OUTPUT
          else
            echo "No consensus reached among classifiers"
            echo "consensus_label=" >> $GITHUB_OUTPUT
          fi

          echo "label_1=$V1" >> $GITHUB_OUTPUT
          echo "label_2=$V2" >> $GITHUB_OUTPUT
          echo "label_3=$V3" >> $GITHUB_OUTPUT

      - name: Post combined analysis comment
        if: steps.validate-key.outputs.has_key == 'true' && (steps.analysis.outcome == 'success' || steps.classify.outcome == 'success')
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');

            function safeRead(path) {
              try { return fs.readFileSync(path, 'utf8').trim() || 'Analysis unavailable for this model'; }
              catch (e) { return 'Analysis unavailable for this model'; }
            }

            const kimiAnalysis = safeRead('/tmp/analysis_kimi.txt');
            const deepseekAnalysis = safeRead('/tmp/analysis_deepseek.txt');
            const qwenAnalysis = safeRead('/tmp/analysis_qwen.txt');

            const consensusLabel = '${{ steps.classify.outputs.consensus_label }}';
            const label1 = '${{ steps.classify.outputs.label_1 }}';
            const label2 = '${{ steps.classify.outputs.label_2 }}';
            const label3 = '${{ steps.classify.outputs.label_3 }}';

            let classificationSummary = '';
            if (consensusLabel) {
              classificationSummary = `\n\n**Consensus Classification**: \`type:${consensusLabel}\` (2+/3 models agreed)\n` +
                `| Model | Classification |\n|-------|----------------|\n` +
                `| llama3.3:70b | ${label1 || 'n/a'} |\n` +
                `| glm-5:cloud | ${label2 || 'n/a'} |\n` +
                `| qwen3.5:cloud | ${label3 || 'n/a'} |`;
            } else {
              classificationSummary = `\n\n**Classification**: No consensus reached among models.\n` +
                `| Model | Classification |\n|-------|----------------|\n` +
                `| llama3.3:70b | ${label1 || 'n/a'} |\n` +
                `| glm-5:cloud | ${label2 || 'n/a'} |\n` +
                `| qwen3.5:cloud | ${label3 || 'n/a'} |`;
            }

            const body = `## ðŸ‘‹ Thanks for opening this issue!\n\n` +
              `We've received your report and our AI triage system has analyzed it below. A maintainer will review shortly.\n\n` +
              `---\n\n` +
              `## AI Triage Analysis\n\n` +
              `Our multi-model AI triage system has analyzed this issue.\n` +
              classificationSummary + `\n\n` +
              `<details>\n<summary>Analysis from kimi-k2.5:cloud</summary>\n\n${kimiAnalysis}\n\n</details>\n\n` +
              `<details>\n<summary>Analysis from deepseek-v3.1:671b-cloud</summary>\n\n${deepseekAnalysis}\n\n</details>\n\n` +
              `<details>\n<summary>Analysis from qwen3-coder-next:cloud</summary>\n\n${qwenAnalysis}\n\n</details>\n\n` +
              `---\n*Automated triage from AI Memory Module*`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });

      - name: Post triage unavailable comment
        if: steps.validate-key.outputs.has_key == 'true' && steps.analysis.outcome != 'success' && steps.classify.outcome != 'success'
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: '## ðŸ‘‹ Thanks for opening this issue!\n\nOur AI triage system is temporarily unavailable. A maintainer will review your issue shortly.\n\n---\n*Automated response from AI Memory Module*'
            });

      - name: Apply consensus label
        if: steps.classify.outputs.consensus_label != ''
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const label = '${{ steps.classify.outputs.consensus_label }}'.trim().toLowerCase();
            const validLabels = ['bug', 'feature', 'question', 'enhancement', 'documentation'];
            if (validLabels.includes(label)) {
              try {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  labels: ['type:' + label]
                });
                console.log('Applied consensus label: type:' + label);
              } catch (e) {
                console.log('Could not apply label: ' + e.message);
              }
            }
