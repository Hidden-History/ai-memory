# AI Code Review Pipeline (Ollama-Only)
# Uses Ollama Cloud API for all AI operations
# Access controlled: Only Hidden-History can trigger @claude
#
# API Provider:
#   - OLLAMA_API_KEY: Ollama Cloud (kimi-k2.5:cloud for review, llama3.3:70b for labeling)
#
# Triggers:
#   - @claude: Quick assist/analysis on issues or PRs
#   - @ai-review: Full code review (for PRs)
#
# Documentation: oversight/plans/GITHUB-SOURCE-OF-TRUTH.md

name: AI Code Review Pipeline

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  access-control:
    name: Check Authorization
    runs-on: ubuntu-latest
    if: contains(github.event.comment.body, '@claude') || contains(github.event.comment.body, '@ai-review')
    outputs:
      authorized: ${{ steps.check.outputs.authorized }}
      trigger_type: ${{ steps.check.outputs.trigger_type }}
      is_pr: ${{ steps.check.outputs.is_pr }}
    steps:
      - name: Check if user is authorized
        id: check
        run: |
          ALLOWED_USERS="Hidden-History"
          ACTOR="${{ github.actor }}"
          echo "Checking authorization for: $ACTOR"

          if echo "$ALLOWED_USERS" | grep -qw "$ACTOR"; then
            echo "authorized=true" >> $GITHUB_OUTPUT
            echo "User $ACTOR is authorized"
          else
            echo "authorized=false" >> $GITHUB_OUTPUT
            echo "User $ACTOR is NOT authorized"
          fi

          if echo "${{ github.event.comment.body }}" | grep -q "@ai-review"; then
            echo "trigger_type=full-review" >> $GITHUB_OUTPUT
          else
            echo "trigger_type=assist" >> $GITHUB_OUTPUT
          fi

          if [ -n "${{ github.event.issue.pull_request }}" ]; then
            echo "is_pr=true" >> $GITHUB_OUTPUT
          else
            echo "is_pr=false" >> $GITHUB_OUTPUT
          fi

      - name: Post unauthorized message
        if: steps.check.outputs.authorized == 'false'
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: 'Sorry @${{ github.actor }}, you are not authorized to trigger the AI assistant.\n\nOnly repository maintainers can use this feature.'
            });

  ai-review:
    name: AI Review (Ollama)
    needs: access-control
    if: needs.access-control.outputs.authorized == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Get context for review
        id: context
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          IS_PR="${{ needs.access-control.outputs.is_pr }}"

          ISSUE_NUMBER="${{ github.event.issue.number }}"
          ISSUE_TITLE="${{ github.event.issue.title }}"
          ISSUE_BODY=$(gh issue view $ISSUE_NUMBER --json body -q '.body' 2>/dev/null | head -100 || echo "")

          if [ "$IS_PR" = "true" ]; then
            gh pr diff $ISSUE_NUMBER > /tmp/diff.txt 2>/dev/null || echo "No diff available" > /tmp/diff.txt
          else
            echo "" > /tmp/diff.txt
          fi

          echo "$ISSUE_TITLE" > /tmp/issue_title.txt
          echo "$ISSUE_BODY" > /tmp/issue_body.txt
          echo "${{ github.event.comment.body }}" > /tmp/comment.txt

          echo "Context gathered for issue #$ISSUE_NUMBER"

      - name: AI Analysis via Ollama Cloud
        id: ollama
        env:
          OLLAMA_API_KEY: ${{ secrets.OLLAMA_API_KEY }}
        run: |
          ISSUE_TITLE=$(cat /tmp/issue_title.txt)
          ISSUE_BODY=$(cat /tmp/issue_body.txt | head -50)
          USER_REQUEST=$(cat /tmp/comment.txt)
          DIFF_CONTENT=$(cat /tmp/diff.txt | head -300)
          IS_PR="${{ needs.access-control.outputs.is_pr }}"

          # Build prompt based on context
          if [ "$IS_PR" = "true" ] && [ -s /tmp/diff.txt ]; then
            PROMPT="You are an AI code reviewer. Analyze this PR and respond to the request.

          PR Title: $ISSUE_TITLE

          PR Description: $ISSUE_BODY

          Code Changes:
          $DIFF_CONTENT

          User Request: $USER_REQUEST

          Focus on: bugs, security, edge cases, improvements. Format in markdown."
          else
            PROMPT="You are an AI assistant for GitHub issues. Analyze and respond.

          Issue Title: $ISSUE_TITLE

          Issue Description: $ISSUE_BODY

          User Request: $USER_REQUEST

          If bug report: analyze root cause, suggest fix, identify affected files. Format in markdown."
          fi

          echo "Calling Ollama Cloud API..."

          RESPONSE=$(curl -s -w "\n%{http_code}" https://ollama.com/api/chat \
            -H "Authorization: Bearer $OLLAMA_API_KEY" \
            -H "Content-Type: application/json" \
            -d "$(jq -n --arg prompt "$PROMPT" '{
              "model": "kimi-k2.5:cloud",
              "messages": [{"role": "user", "content": $prompt}],
              "stream": false
            }')")

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          echo "HTTP Status: $HTTP_CODE"

          if [ "$HTTP_CODE" != "200" ]; then
            echo "API Error: $BODY"
            echo "review_ready=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          REVIEW=$(echo "$BODY" | jq -r '.message.content // empty')

          if [ -n "$REVIEW" ]; then
            echo "$REVIEW" > /tmp/review.txt
            echo "review_ready=true" >> $GITHUB_OUTPUT
            echo "Review received: $(wc -c < /tmp/review.txt) chars"
          else
            echo "No review content received"
            echo "Raw response: $BODY"
            echo "review_ready=false" >> $GITHUB_OUTPUT
          fi

      - name: Post AI response
        if: steps.ollama.outputs.review_ready == 'true'
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const review = fs.readFileSync('/tmp/review.txt', 'utf8');
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: '## ðŸ¤– AI Analysis (Ollama kimi-k2.5:cloud)\n\n' + review + '\n\n---\n*Triggered by @${{ github.actor }}*'
            });

      - name: Post error message
        if: steps.ollama.outputs.review_ready != 'true'
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: '## âš ï¸ AI Review Failed\n\nCould not complete AI analysis. Check [workflow logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}).'
            });

  auto-label:
    name: Auto-Label PR
    needs: access-control
    if: needs.access-control.outputs.authorized == 'true' && needs.access-control.outputs.is_pr == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Classify PR type
        id: classify
        env:
          OLLAMA_API_KEY: ${{ secrets.OLLAMA_API_KEY }}
        run: |
          PR_TITLE="${{ github.event.issue.title }}"

          PROMPT="Classify this PR title as ONE of: bug, feature, docs, refactor, test, chore. Title: $PR_TITLE. Return ONLY the single word."

          RESPONSE=$(curl -s https://ollama.com/api/chat \
            -H "Authorization: Bearer $OLLAMA_API_KEY" \
            -H "Content-Type: application/json" \
            -d "$(jq -n --arg prompt "$PROMPT" '{
              "model": "llama3.3:70b",
              "messages": [{"role": "user", "content": $prompt}],
              "stream": false
            }')")

          LABEL=$(echo "$RESPONSE" | jq -r '.message.content // empty' | tr -d '[:space:]' | tr '[:upper:]' '[:lower:]')

          echo "Classified as: $LABEL"
          echo "label=$LABEL" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Apply label
        if: steps.classify.outputs.label != ''
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const label = '${{ steps.classify.outputs.label }}'.trim().toLowerCase();
            const validLabels = ['bug', 'feature', 'docs', 'refactor', 'test', 'chore'];
            if (validLabels.includes(label)) {
              try {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  labels: ['type:' + label]
                });
                console.log('Applied label: type:' + label);
              } catch (e) {
                console.log('Could not apply label: ' + e.message);
              }
            }

