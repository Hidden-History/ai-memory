# AI Code Review Pipeline
# Multi-model approach: Claude (primary) + Ollama Cloud (verification + labeling)
# Access controlled: Only Hidden-History can trigger @claude
#
# API Providers:
#   - ANTHROPIC_API_KEY: Claude (primary review via claude-code-action) [optional]
#   - OLLAMA_API_KEY: Ollama Cloud (verification with gpt-oss:120b, labeling with llama3.3:70b)
#
# Documentation: oversight/plans/GITHUB-SOURCE-OF-TRUTH.md

name: AI Code Review Pipeline

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

# Limit permissions for security
permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  # ============================================================
  # ACCESS CONTROL - Only authorized users can trigger AI
  # ============================================================
  access-control:
    name: Check Authorization
    runs-on: ubuntu-latest
    if: |
      contains(github.event.comment.body, '@claude') ||
      contains(github.event.comment.body, '@ai-review')
    outputs:
      authorized: ${{ steps.check.outputs.authorized }}
      trigger_type: ${{ steps.check.outputs.trigger_type }}
    steps:
      - name: Check if user is authorized
        id: check
        run: |
          # Allowed users list - add more as needed
          ALLOWED_USERS="Hidden-History"

          ACTOR="${{ github.actor }}"
          echo "Checking authorization for: $ACTOR"

          if echo "$ALLOWED_USERS" | grep -qw "$ACTOR"; then
            echo "authorized=true" >> $GITHUB_OUTPUT
            echo "User $ACTOR is authorized"
          else
            echo "authorized=false" >> $GITHUB_OUTPUT
            echo "User $ACTOR is NOT authorized"
          fi

          # Determine trigger type
          if echo "${{ github.event.comment.body }}" | grep -q "@ai-review"; then
            echo "trigger_type=full-review" >> $GITHUB_OUTPUT
          else
            echo "trigger_type=assist" >> $GITHUB_OUTPUT
          fi

      - name: Post unauthorized message
        if: steps.check.outputs.authorized == 'false'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `Sorry @${{ github.actor }}, you are not authorized to trigger the AI assistant.\n\nOnly repository maintainers can use this feature.`
            });

  # ============================================================
  # TIER 1: PRIMARY REVIEW - Claude via Anthropic API
  # ============================================================
  primary-review:
    name: Claude Primary Review
    needs: access-control
    if: needs.access-control.outputs.authorized == 'true'
    runs-on: ubuntu-latest
    outputs:
      review_complete: ${{ steps.review.outputs.complete }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Claude Code Review
        id: review
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          # Model is configured in the action
        continue-on-error: true

      - name: Set review status
        run: echo "complete=true" >> $GITHUB_OUTPUT

  # ============================================================
  # TIER 2: VERIFICATION - Ollama Cloud API
  # Uses different model to catch Claude's blind spots
  # ============================================================
  verification-review:
    name: AI Verification Review
    needs: [access-control, primary-review]
    if: |
      needs.access-control.outputs.authorized == 'true' &&
      needs.access-control.outputs.trigger_type == 'full-review'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR diff
        id: diff
        run: |
          # Get diff from PR or fallback to recent commit
          if [ -n "${{ github.event.issue.pull_request.url }}" ]; then
            PR_NUMBER="${{ github.event.issue.number }}"
            gh pr diff $PR_NUMBER > /tmp/diff.txt || git diff HEAD~1 > /tmp/diff.txt
          else
            git diff HEAD~1 > /tmp/diff.txt
          fi

          # Store diff content as output (max 500 lines to avoid token limits)
          DIFF_CONTENT=$(cat /tmp/diff.txt | head -500)
          echo "diff_content<<EOF" >> $GITHUB_OUTPUT
          echo "$DIFF_CONTENT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "Diff captured: $(wc -l < /tmp/diff.txt) lines"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: AI Verification via Ollama Cloud
        id: ollama
        env:
          OLLAMA_API_KEY: ${{ secrets.OLLAMA_API_KEY }}
        run: |
          # Get diff content and escape for JSON
          DIFF_CONTENT=$(cat /tmp/diff.txt | head -500)

          # Build the prompt
          PROMPT="You are a code reviewer providing a second opinion. Focus on:
          1. Edge cases that might be missed
          2. Security vulnerabilities
          3. Error handling gaps
          4. Performance concerns
          5. Logic errors

          Only report significant issues. Be concise.

          Code changes:
          $DIFF_CONTENT"

          # Call Ollama Cloud API
          RESPONSE=$(curl -s https://ollama.com/api/chat \
            -H "Authorization: Bearer $OLLAMA_API_KEY" \
            -H "Content-Type: application/json" \
            -d "$(jq -n --arg prompt "$PROMPT" '{
              "model": "gpt-oss:120b",
              "messages": [{"role": "user", "content": $prompt}],
              "stream": false
            }')")

          # Extract the response content (Ollama format: message.content)
          REVIEW=$(echo "$RESPONSE" | jq -r '.message.content // .choices[0].message.content // empty')

          if [ -n "$REVIEW" ]; then
            # Use a unique delimiter to avoid issues with special characters
            DELIMITER=$(openssl rand -hex 8)
            echo "review<<$DELIMITER" >> $GITHUB_OUTPUT
            echo "$REVIEW" >> $GITHUB_OUTPUT
            echo "$DELIMITER" >> $GITHUB_OUTPUT
            echo "Review received: ${#REVIEW} chars"
          else
            echo "No review content received"
            echo "API Response: $RESPONSE"
          fi
        continue-on-error: true

      - name: Post AI review as comment
        if: steps.ollama.outputs.review != ''
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const review = process.env.REVIEW_CONTENT;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## ðŸ” AI Verification Review (Ollama Cloud)\n\n${review}`
            });
        env:
          REVIEW_CONTENT: ${{ steps.ollama.outputs.review }}

  # ============================================================
  # TIER 3: AUTO-LABELING - Ollama Cloud (llama3.3:70b)
  # ============================================================
  auto-label:
    name: Auto-Label PR
    needs: access-control
    if: |
      needs.access-control.outputs.authorized == 'true' &&
      github.event.issue.pull_request != null
    runs-on: ubuntu-latest
    steps:
      - name: Get PR info
        id: pr-info
        run: |
          PR_TITLE="${{ github.event.issue.title }}"
          echo "title=$PR_TITLE" >> $GITHUB_OUTPUT

      - name: Classify PR type
        id: classify
        env:
          OLLAMA_API_KEY: ${{ secrets.OLLAMA_API_KEY }}
        run: |
          PR_TITLE="${{ github.event.issue.title }}"

          PROMPT="Based on this PR title, classify as ONE of:
          - bug (fixing something broken)
          - feature (new functionality)
          - docs (documentation)
          - refactor (code improvement, no behavior change)
          - test (test changes)
          - chore (maintenance)

          Title: $PR_TITLE

          Return ONLY the single word label, nothing else."

          # Call Ollama Cloud API
          RESPONSE=$(curl -s https://ollama.com/api/chat \
            -H "Authorization: Bearer $OLLAMA_API_KEY" \
            -H "Content-Type: application/json" \
            -d "$(jq -n --arg prompt "$PROMPT" '{
              "model": "llama3.3:70b",
              "messages": [{"role": "user", "content": $prompt}],
              "stream": false
            }')")

          # Extract the label (Ollama format: message.content)
          LABEL=$(echo "$RESPONSE" | jq -r '.message.content // .choices[0].message.content // empty' | tr -d '[:space:]' | tr '[:upper:]' '[:lower:]')

          echo "Classified as: $LABEL"
          echo "label=$LABEL" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Apply label
        if: steps.classify.outputs.label != ''
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const label = '${{ steps.classify.outputs.label }}'.trim().toLowerCase();
            const validLabels = ['bug', 'feature', 'docs', 'refactor', 'test', 'chore'];
            if (validLabels.includes(label)) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: [`type:${label}`]
              });
              console.log(`Applied label: type:${label}`);
            } else {
              console.log(`Invalid label from LLM: ${label}`);
            }
