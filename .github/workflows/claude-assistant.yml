# AI Code Review Pipeline (Ollama-Only)
# Uses Ollama Cloud API for all AI operations
# Access controlled: Only Hidden-History can trigger @claude
#
# API Provider:
#   - OLLAMA_API_KEY: Ollama Cloud (kimi-k2.5:cloud for review, llama3.3:70b for labeling)
#
# Triggers:
#   - @claude: Quick assist/analysis on issues or PRs
#   - @ai-review: Full code review (for PRs)
#
# Documentation: oversight/plans/GITHUB-SOURCE-OF-TRUTH.md

name: AI Code Review Pipeline

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  access-control:
    name: Check Authorization
    runs-on: ubuntu-latest
    if: contains(github.event.comment.body, '@claude') || contains(github.event.comment.body, '@ai-review')
    outputs:
      authorized: ${{ steps.check.outputs.authorized }}
      trigger_type: ${{ steps.check.outputs.trigger_type }}
      is_pr: ${{ steps.check.outputs.is_pr }}
    steps:
      - name: Check if user is authorized
        id: check
        run: |
          ALLOWED_USERS="Hidden-History"
          ACTOR="${{ github.actor }}"
          echo "Checking authorization for: $ACTOR"

          if echo "$ALLOWED_USERS" | grep -qw "$ACTOR"; then
            echo "authorized=true" >> $GITHUB_OUTPUT
            echo "User $ACTOR is authorized"
          else
            echo "authorized=false" >> $GITHUB_OUTPUT
            echo "User $ACTOR is NOT authorized"
          fi

          if echo "${{ github.event.comment.body }}" | grep -q "@ai-review"; then
            echo "trigger_type=full-review" >> $GITHUB_OUTPUT
          else
            echo "trigger_type=assist" >> $GITHUB_OUTPUT
          fi

          if [ -n "${{ github.event.issue.pull_request }}" ]; then
            echo "is_pr=true" >> $GITHUB_OUTPUT
          else
            echo "is_pr=false" >> $GITHUB_OUTPUT
          fi

      - name: Post unauthorized message
        if: steps.check.outputs.authorized == 'false'
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: 'Sorry @${{ github.actor }}, you are not authorized to trigger the AI assistant.\n\nOnly repository maintainers can use this feature.'
            });

  ai-review:
    name: AI Review (Ollama)
    needs: access-control
    if: needs.access-control.outputs.authorized == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      # TECH-DEBT-090 Task 2: Validate API credentials before making any API calls
      - name: Validate API credentials
        env:
          OLLAMA_API_KEY: ${{ secrets.OLLAMA_API_KEY }}
        run: |
          if [ -z "$OLLAMA_API_KEY" ]; then
            echo "::error::OLLAMA_API_KEY secret is not configured"
            exit 1
          fi
          echo "âœ“ API key validation passed"

      # TECH-DEBT-090 Tasks 4 & 8: Diff is read only once to avoid redundant GitHub API calls.
      # If future jobs need diff access, use GitHub Actions outputs with secure delimiters
      # (e.g., EOF_$(date +%s%N)_${RANDOM}) instead of multiple gh pr diff calls.
      - name: Get context for review
        id: context
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          IS_PR="${{ needs.access-control.outputs.is_pr }}"

          ISSUE_NUMBER="${{ github.event.issue.number }}"
          ISSUE_TITLE="${{ github.event.issue.title }}"
          ISSUE_BODY=$(gh issue view $ISSUE_NUMBER --json body -q '.body' 2>/dev/null | head -100 || echo "")

          if [ "$IS_PR" = "true" ]; then
            gh pr diff $ISSUE_NUMBER > /tmp/diff.txt 2>/dev/null || echo "No diff available" > /tmp/diff.txt
          else
            echo "" > /tmp/diff.txt
          fi

          echo "$ISSUE_TITLE" > /tmp/issue_title.txt
          echo "$ISSUE_BODY" > /tmp/issue_body.txt
          echo "${{ github.event.comment.body }}" > /tmp/comment.txt

          echo "Context gathered for issue #$ISSUE_NUMBER"

      # TECH-DEBT-090: Hardened AI analysis with secret redaction, JSON escaping, and retry logic
      - name: AI Analysis via Ollama Cloud
        id: ollama
        env:
          OLLAMA_API_KEY: ${{ secrets.OLLAMA_API_KEY }}
        run: |
          ISSUE_TITLE=$(cat /tmp/issue_title.txt)
          ISSUE_BODY=$(cat /tmp/issue_body.txt | head -50)
          USER_REQUEST=$(cat /tmp/comment.txt)
          IS_PR="${{ needs.access-control.outputs.is_pr }}"

          # TECH-DEBT-090 Task 5: Read and redact potential secrets from diff
          DIFF_RAW=$(cat /tmp/diff.txt | head -300)

          # TECH-DEBT-090 Task 5b: Skip AI review if diff touches sensitive files
          if echo "$DIFF_RAW" | grep -qE '^\+\+\+ b/.*(\.env|\.env\.|credentials|\.pem|\.key|id_rsa|\.p12|\.pfx)'; then
            echo "::warning::Diff contains changes to sensitive files â€” skipping AI review for safety"
            echo "review_ready=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          DIFF_FILTERED=$(echo "$DIFF_RAW" | \
            sed -E 's/(api[_-]?key|password|secret|token|bearer|private[_-]?key|client[_-]?secret)[[:space:]]*[:=][[:space:]]*["\047]?[^"\047[:space:]]+["\047]?/\1=***REDACTED***/gI' | \
            sed -E 's/(AWS|GITHUB|ANTHROPIC|OPENAI|OLLAMA|OAUTH)[_-]?(SECRET|TOKEN|KEY|PASSWORD)[_A-Z]*[[:space:]]*[:=][[:space:]]*[^[:space:]]+/\1_\2=***REDACTED***/g' | \
            sed -E 's/"[a-zA-Z_]*([Ss]ecret|[Tt]oken|[Kk]ey|[Pp]assword)"[[:space:]]*:[[:space:]]*"[^"]+"/"\1":"***REDACTED***"/g')

          # TECH-DEBT-090 Task 1: Build JSON payload with proper escaping using jq
          if [ "$IS_PR" = "true" ] && [ -s /tmp/diff.txt ]; then
            PAYLOAD=$(jq -n \
              --arg title "$ISSUE_TITLE" \
              --arg body "$ISSUE_BODY" \
              --arg diff "$DIFF_FILTERED" \
              --arg request "$USER_REQUEST" \
              '{
                "model": "kimi-k2.5:cloud",
                "messages": [{
                  "role": "user",
                  "content": ("You are an AI code reviewer. Analyze this PR and respond to the request.\n\n" +
                    "PR Title: " + $title + "\n\n" +
                    "PR Description: " + $body + "\n\n" +
                    "Code Changes:\n" + $diff + "\n\n" +
                    "User Request: " + $request + "\n\n" +
                    "Focus on: bugs, security, edge cases, improvements. Format in markdown.")
                }],
                "stream": false
              }')
          else
            PAYLOAD=$(jq -n \
              --arg title "$ISSUE_TITLE" \
              --arg body "$ISSUE_BODY" \
              --arg request "$USER_REQUEST" \
              '{
                "model": "kimi-k2.5:cloud",
                "messages": [{
                  "role": "user",
                  "content": ("You are an AI assistant for GitHub issues. Analyze and respond.\n\n" +
                    "Issue Title: " + $title + "\n\n" +
                    "Issue Description: " + $body + "\n\n" +
                    "User Request: " + $request + "\n\n" +
                    "If bug report: analyze root cause, suggest fix, identify affected files. Format in markdown.")
                }],
                "stream": false
              }')
          fi

          # TECH-DEBT-090 Task 3: Retry logic with exponential backoff and error handling
          echo "Calling Ollama Cloud API..."
          REVIEW_READY=false

          for attempt in 1 2 3; do
            echo "API call attempt $attempt/3..."

            # -s: silent, no -f: let HTTP errors return body for diagnosis
            # || true: prevent bash -e from aborting on curl timeout (exit 28)
            RESPONSE=$(curl -s --max-time 120 \
              -w "\n%{http_code}" \
              https://ollama.com/api/chat \
              -H "Authorization: Bearer $OLLAMA_API_KEY" \
              -H "Content-Type: application/json" \
              -d "$PAYLOAD" 2>&1) || true

            HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
            BODY=$(echo "$RESPONSE" | sed '$d')

            # Handle curl timeout (empty or non-numeric HTTP code)
            if ! echo "$HTTP_CODE" | grep -qE '^[0-9]+$'; then
              echo "::warning::curl failed (timeout or network error) on attempt $attempt"
              HTTP_CODE=0
            fi

            echo "HTTP Status: $HTTP_CODE"

            # Success: HTTP 2xx
            if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ] 2>/dev/null; then
              echo "âœ“ API call succeeded (HTTP $HTTP_CODE)"

              REVIEW=$(echo "$BODY" | jq -r '.message.content // empty')

              if [ -n "$REVIEW" ]; then
                echo "$REVIEW" > /tmp/review.txt
                echo "review_ready=true" >> $GITHUB_OUTPUT
                echo "Review received: $(wc -c < /tmp/review.txt) chars"
                REVIEW_READY=true
                break
              else
                echo "::warning::No review content in response"
                echo "Raw response: $BODY"
              fi
            else
              echo "::warning::API call failed (HTTP $HTTP_CODE)"
              echo "Response: $BODY"

              # Don't retry client errors (4xx) â€” only retry server errors (5xx) and timeouts
              if [ "$HTTP_CODE" -ge 400 ] && [ "$HTTP_CODE" -lt 500 ] 2>/dev/null; then
                echo "::error::Client error (HTTP $HTTP_CODE) â€” not retrying"
                break
              fi
            fi

            # Retry with exponential backoff (except on last attempt)
            if [ $attempt -lt 3 ]; then
              BACKOFF=$((5 * (2 ** (attempt - 1))))
              echo "Retrying in ${BACKOFF}s..."
              sleep $BACKOFF
            fi
          done

          # Final status
          if [ "$REVIEW_READY" = false ]; then
            echo "::error::API call failed after 3 attempts"
            echo "review_ready=false" >> $GITHUB_OUTPUT
          fi

      - name: Post AI response
        if: steps.ollama.outputs.review_ready == 'true'
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const review = fs.readFileSync('/tmp/review.txt', 'utf8');
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: '## ðŸ¤– AI Analysis (Ollama kimi-k2.5:cloud)\n\n' + review + '\n\n---\n*Triggered by @${{ github.actor }}*'
            });

      - name: Post error message
        if: steps.ollama.outputs.review_ready != 'true'
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: '## âš ï¸ AI Review Failed\n\nCould not complete AI analysis. Check [workflow logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}).'
            });

  auto-label:
    name: Auto-Label PR
    needs: access-control
    if: needs.access-control.outputs.authorized == 'true' && needs.access-control.outputs.is_pr == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Validate API credentials
        id: validate-key
        env:
          OLLAMA_API_KEY: ${{ secrets.OLLAMA_API_KEY }}
        run: |
          if [ -z "$OLLAMA_API_KEY" ]; then
            echo "::warning::OLLAMA_API_KEY not configured â€” skipping auto-label"
            echo "has_key=false" >> $GITHUB_OUTPUT
          else
            echo "has_key=true" >> $GITHUB_OUTPUT
          fi

      # TECH-DEBT-090 Task 3: Hardened PR classification with retry logic
      - name: Classify PR type
        if: steps.validate-key.outputs.has_key == 'true'
        id: classify
        env:
          OLLAMA_API_KEY: ${{ secrets.OLLAMA_API_KEY }}
        run: |
          PR_TITLE="${{ github.event.issue.title }}"

          # Build JSON payload with proper escaping
          PAYLOAD=$(jq -n \
            --arg title "$PR_TITLE" \
            '{
              "model": "llama3.3:70b",
              "messages": [{
                "role": "user",
                "content": ("Classify this PR title as ONE of: bug, feature, docs, refactor, test, chore. Title: " + $title + ". Return ONLY the single word.")
              }],
              "stream": false
            }')

          # Retry logic with exponential backoff
          LABEL=""
          for attempt in 1 2 3; do
            echo "Classification attempt $attempt/3..."

            RESPONSE=$(curl -s --max-time 60 \
              https://ollama.com/api/chat \
              -H "Authorization: Bearer $OLLAMA_API_KEY" \
              -H "Content-Type: application/json" \
              -d "$PAYLOAD" 2>&1) || true

            # Extract label if successful
            LABEL=$(echo "$RESPONSE" | jq -r '.message.content // empty' 2>/dev/null | tr -d '[:space:]' | tr '[:upper:]' '[:lower:]')

            if [ -n "$LABEL" ]; then
              echo "âœ“ Classified as: $LABEL"
              echo "label=$LABEL" >> $GITHUB_OUTPUT
              break
            fi

            # Retry with backoff (except on last attempt)
            if [ $attempt -lt 3 ]; then
              BACKOFF=$((5 * (2 ** (attempt - 1))))
              echo "::warning::Classification failed, retrying in ${BACKOFF}s..."
              sleep $BACKOFF
            fi
          done

          if [ -z "$LABEL" ]; then
            echo "::warning::Failed to classify PR after 3 attempts"
            echo "label=" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: Apply label
        if: steps.validate-key.outputs.has_key == 'true' && steps.classify.outputs.label != ''
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const label = '${{ steps.classify.outputs.label }}'.trim().toLowerCase();
            const validLabels = ['bug', 'feature', 'docs', 'refactor', 'test', 'chore'];
            if (validLabels.includes(label)) {
              try {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  labels: ['type:' + label]
                });
                console.log('Applied label: type:' + label);
              } catch (e) {
                console.log('Could not apply label: ' + e.message);
              }
            }

