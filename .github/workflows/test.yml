name: Test Suite

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: test-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  # ============================================================================
  # LINT - Fast code quality checks
  # ============================================================================
  lint:
    name: Lint
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.11"
          cache: pip
          cache-dependency-path: pyproject.toml

      - name: Install linters
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run ruff
        run: ruff check --output-format=github src/ tests/

      - name: Check black formatting
        run: black --check src/ tests/

      - name: Check isort
        run: isort --check-only --profile black src/ tests/

  # ============================================================================
  # UNIT TESTS - Fast tests without external dependencies
  # ============================================================================
  unit-tests:
    name: Unit Tests (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    timeout-minutes: 15
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.10", "3.11", "3.12"]

    steps:
      - uses: actions/checkout@v6

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}
          cache: pip
          cache-dependency-path: pyproject.toml

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run unit tests
        run: |
          pytest tests/ -v --tb=short \
            --ignore=tests/e2e \
            --ignore=tests/integration \
            --cov=src/memory --cov-report=xml --cov-fail-under=60
        env:
          CI: "true"

      - name: Upload coverage
        if: matrix.python-version == '3.11'
        uses: codecov/codecov-action@v5
        with:
          files: coverage.xml
          fail_ci_if_error: false
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  # ============================================================================
  # INTEGRATION TESTS - Tests requiring Qdrant service
  # ============================================================================
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: unit-tests

    services:
      qdrant:
        image: qdrant/qdrant:v1.14.0  # Pin version for reproducibility (SPEC-001: FormulaQuery API)
        ports:
          - 6333:6333
          - 6334:6334
        # No health-cmd - Qdrant image lacks curl/wget (security hardening)
        # Health check performed via Python step below

    steps:
      - uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.11"
          cache: pip
          cache-dependency-path: pyproject.toml

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Wait for Qdrant
        run: |
          python3 << 'EOF'
          import urllib.request
          import time
          import sys

          url = 'http://localhost:6333/readyz'
          max_attempts = 30
          delay = 2

          print(f"Waiting for Qdrant at {url}...")
          for attempt in range(max_attempts):
              try:
                  response = urllib.request.urlopen(url, timeout=5)
                  if response.status == 200:
                      print(f"Qdrant ready after {attempt * delay} seconds")
                      sys.exit(0)
              except Exception as e:
                  print(f"Attempt {attempt + 1}/{max_attempts}: {type(e).__name__}")
                  time.sleep(delay)

          print("Qdrant failed to become ready after 60 seconds")
          sys.exit(1)
          EOF

      - name: Run integration tests
        run: |
          pytest tests/integration -v --tb=short \
            --run-integration \
            -m "not requires_embedding"
        env:
          CI: "true"
          QDRANT_HOST: localhost
          QDRANT_PORT: "6333"

  # ============================================================================
  # E2E TESTS - Playwright browser tests (optional, runs after integration)
  # ============================================================================
  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: integration-tests
    # Only run E2E if explicitly enabled or on main branch
    if: github.ref == 'refs/heads/main' || contains(github.event.head_commit.message, '[e2e]')

    steps:
      - uses: actions/checkout@v6

      # Create .env file with dummy credentials for CI
      - name: Create Docker environment file
        working-directory: docker
        run: |
          # Pre-compute shell expansions
          TIMESTAMP=$(date +%s%N)
          PROM_AUTH=$(echo -n "admin:ci-test-prometheus-password" | base64)

          cat > .env << EOF
# Dummy credentials for CI - security not required for ephemeral test environment
QDRANT_API_KEY=ci-test-key-${TIMESTAMP}
GRAFANA_ADMIN_USER=admin
GRAFANA_ADMIN_PASSWORD=ci-test-password
GRAFANA_SECRET_KEY=ci-test-secret-key-32-characters-long
PROMETHEUS_ADMIN_PASSWORD=ci-test-prometheus-password
PROMETHEUS_BASIC_AUTH_HEADER=Basic ${PROM_AUTH}
QDRANT_PORT=26350
QDRANT_GRPC_PORT=26351
EMBEDDING_PORT=28080
AI_MEMORY_CONTAINER_PREFIX=ci-ai-memory
QDRANT_LOG_LEVEL=INFO
AI_MEMORY_LOG_LEVEL=INFO
BMAD_LOG_LEVEL=INFO
EOF

      # Generate Prometheus web.yml with matching bcrypt hash for CI
      - name: Generate Prometheus auth for CI
        working-directory: docker
        run: |
          pip install bcrypt
          HASH=$(python3 -c "import bcrypt; print(bcrypt.hashpw(b'ci-test-prometheus-password', bcrypt.gensalt(12)).decode())")
          echo "basic_auth_users:" > prometheus/web.yml
          echo "  admin: $HASH" >> prometheus/web.yml

      # Start all E2E services with docker-compose
      - name: Start Docker services
        working-directory: docker
        run: |
          echo "Starting E2E services with docker-compose..."
          docker compose --profile monitoring up -d qdrant embedding prometheus grafana monitoring-api
          echo "Services started. Waiting for health checks..."

      # Wait for Qdrant to be ready
      - name: Wait for Qdrant to be ready
        run: |
          python3 << 'HEALTH_CHECK'
          import urllib.request
          import time
          import sys

          url = 'http://localhost:26350/readyz'
          max_attempts = 30
          delay = 2

          print("Waiting for Qdrant...")
          for attempt in range(1, max_attempts + 1):
              try:
                  with urllib.request.urlopen(url, timeout=5) as response:
                      if response.status == 200:
                          print(f"✓ Qdrant ready after {attempt} attempts ({attempt * delay}s)")
                          sys.exit(0)
              except Exception as e:
                  if attempt % 5 == 0:
                      print(f"Attempt {attempt}/{max_attempts}: {e}")
                  if attempt < max_attempts:
                      time.sleep(delay)

          print("✗ Qdrant failed to become ready within 60s")
          sys.exit(1)
          HEALTH_CHECK

      # Wait for Embedding service to be ready
      - name: Wait for Embedding service to be ready
        run: |
          python3 << 'HEALTH_CHECK'
          import urllib.request
          import time
          import sys

          url = 'http://localhost:28080/health'
          max_attempts = 150  # 300s total (embedding needs model download time)
          delay = 2

          print("Waiting for Embedding service (may take up to 5 minutes for first-time model download)...")
          for attempt in range(1, max_attempts + 1):
              try:
                  with urllib.request.urlopen(url, timeout=10) as response:
                      if response.status == 200:
                          print(f"✓ Embedding service ready after {attempt} attempts ({attempt * delay}s)")
                          sys.exit(0)
              except Exception as e:
                  if attempt % 10 == 0:  # Log every 20 seconds
                      print(f"Attempt {attempt}/{max_attempts}: {e}")
                  if attempt < max_attempts:
                      time.sleep(delay)

          print("✗ Embedding service failed to become ready within 300s")
          sys.exit(1)
          HEALTH_CHECK

      # Wait for Prometheus to be ready
      - name: Wait for Prometheus to be ready
        run: |
          python3 << 'HEALTH_CHECK'
          import urllib.request
          import time
          import sys
          import base64

          url = 'http://localhost:29090/-/healthy'
          max_attempts = 30  # 60s total
          delay = 2

          # Add Basic Auth header
          auth_string = base64.b64encode(b"admin:ci-test-prometheus-password").decode()
          auth_header = f"Basic {auth_string}"

          print("Waiting for Prometheus...")
          for attempt in range(1, max_attempts + 1):
              try:
                  req = urllib.request.Request(url, headers={"Authorization": auth_header})
                  with urllib.request.urlopen(req, timeout=5) as response:
                      if response.status == 200:
                          print(f"✓ Prometheus ready after {attempt} attempts ({attempt * delay}s)")
                          sys.exit(0)
              except Exception as e:
                  if attempt % 5 == 0:
                      print(f"Attempt {attempt}/{max_attempts}: {e}")
                  if attempt < max_attempts:
                      time.sleep(delay)

          print("✗ Prometheus failed to become ready within 60s")
          sys.exit(1)
          HEALTH_CHECK

      # Wait for Monitoring API to be ready
      - name: Wait for Monitoring API to be ready
        run: |
          python3 << 'HEALTH_CHECK'
          import urllib.request
          import time
          import sys

          url = 'http://localhost:28000/health'
          max_attempts = 30  # 60s total
          delay = 2

          print("Waiting for Monitoring API...")
          for attempt in range(1, max_attempts + 1):
              try:
                  with urllib.request.urlopen(url, timeout=5) as response:
                      if response.status == 200:
                          print(f"✓ Monitoring API ready after {attempt} attempts ({attempt * delay}s)")
                          sys.exit(0)
              except Exception as e:
                  if attempt % 5 == 0:
                      print(f"Attempt {attempt}/{max_attempts}: {e}")
                  if attempt < max_attempts:
                      time.sleep(delay)

          print("✗ Monitoring API failed to become ready within 60s")
          sys.exit(1)
          HEALTH_CHECK

      # Wait for Grafana to be ready
      - name: Wait for Grafana to be ready
        run: |
          python3 << 'HEALTH_CHECK'
          import urllib.request
          import time
          import sys

          url = 'http://localhost:23000/api/health'
          max_attempts = 30  # 60s total
          delay = 2

          print("Waiting for Grafana...")
          for attempt in range(1, max_attempts + 1):
              try:
                  with urllib.request.urlopen(url, timeout=5) as response:
                      if response.status == 200:
                          print(f"✓ Grafana ready after {attempt} attempts ({attempt * delay}s)")
                          sys.exit(0)
              except Exception as e:
                  if attempt % 5 == 0:
                      print(f"Attempt {attempt}/{max_attempts}: {e}")
                  if attempt < max_attempts:
                      time.sleep(delay)

          print("✗ Grafana failed to become ready within 60s")
          sys.exit(1)
          HEALTH_CHECK

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.11"
          cache: pip

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Get Playwright version
        id: playwright-version
        run: |
          VERSION=$(python -c "from importlib.metadata import version; print(version('playwright'))")
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Cache Playwright browsers
        uses: actions/cache@v5
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ steps.playwright-version.outputs.version }}

      - name: Install Playwright browsers
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: python -m playwright install --with-deps chromium

      - name: Install Playwright OS dependencies
        if: steps.playwright-cache.outputs.cache-hit == 'true'
        run: python -m playwright install-deps chromium

      - name: Run E2E tests
        run: |
          pytest tests/e2e -v --tb=short \
            --run-e2e \
            --browser chromium
        env:
          CI: "true"

      - name: Cleanup Docker services
        if: always()
        working-directory: docker
        run: |
          echo "Cleaning up Docker services..."
          docker compose --profile monitoring down -v --remove-orphans 2>/dev/null || true
          echo "Docker cleanup complete"

  # ============================================================================
  # CI SUCCESS - Summary job for branch protection
  # ============================================================================
  ci-success:
    name: CI Success
    needs: [lint, unit-tests, integration-tests]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Check all results
        run: |
          echo "Lint: ${{ needs.lint.result }}"
          echo "Unit Tests: ${{ needs.unit-tests.result }}"
          echo "Integration Tests: ${{ needs.integration-tests.result }}"

          if [[ "${{ needs.lint.result }}" != "success" ]]; then
            echo "::error::Lint checks failed"
            exit 1
          fi
          if [[ "${{ needs.unit-tests.result }}" != "success" ]]; then
            echo "::error::Unit tests failed"
            exit 1
          fi
          if [[ "${{ needs.integration-tests.result }}" != "success" ]]; then
            echo "::error::Integration tests failed"
            exit 1
          fi
          echo "All CI checks passed!"
