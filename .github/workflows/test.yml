name: Test Suite

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: test-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  # ============================================================================
  # LINT - Fast code quality checks
  # ============================================================================
  lint:
    name: Lint
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.11"
          cache: pip
          cache-dependency-path: pyproject.toml

      - name: Install linters
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run ruff
        run: ruff check --output-format=github src/ tests/

      - name: Check black formatting
        run: black --check src/ tests/

      - name: Check isort
        run: isort --check-only --profile black src/ tests/

  # ============================================================================
  # UNIT TESTS - Fast tests without external dependencies
  # ============================================================================
  unit-tests:
    name: Unit Tests (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    timeout-minutes: 15
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.10", "3.11", "3.12"]

    steps:
      - uses: actions/checkout@v6

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}
          cache: pip
          cache-dependency-path: pyproject.toml

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run unit tests
        run: |
          pytest tests/ -v --tb=short \
            --ignore=tests/e2e \
            --ignore=tests/integration \
            --cov=src/memory --cov-report=xml --cov-fail-under=60
        env:
          CI: "true"

      - name: Upload coverage
        if: matrix.python-version == '3.11'
        uses: codecov/codecov-action@v5
        with:
          files: coverage.xml
          fail_ci_if_error: false
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  # ============================================================================
  # INTEGRATION TESTS - Tests requiring Qdrant service
  # ============================================================================
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: unit-tests

    services:
      qdrant:
        image: qdrant/qdrant:v1.12.1  # Pin version for reproducibility
        ports:
          - 6333:6333
          - 6334:6334
        # No health-cmd - Qdrant image lacks curl/wget (security hardening)
        # Health check performed via Python step below

    steps:
      - uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.11"
          cache: pip
          cache-dependency-path: pyproject.toml

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Wait for Qdrant
        run: |
          python3 << 'EOF'
          import urllib.request
          import time
          import sys

          url = 'http://localhost:6333/readyz'
          max_attempts = 30
          delay = 2

          print(f"Waiting for Qdrant at {url}...")
          for attempt in range(max_attempts):
              try:
                  response = urllib.request.urlopen(url, timeout=5)
                  if response.status == 200:
                      print(f"Qdrant ready after {attempt * delay} seconds")
                      sys.exit(0)
              except Exception as e:
                  print(f"Attempt {attempt + 1}/{max_attempts}: {type(e).__name__}")
                  time.sleep(delay)

          print("Qdrant failed to become ready after 60 seconds")
          sys.exit(1)
          EOF

      - name: Run integration tests
        run: |
          pytest tests/integration -v --tb=short \
            --run-integration \
            -m "not requires_embedding"
        env:
          CI: "true"
          QDRANT_HOST: localhost
          QDRANT_PORT: "6333"

  # ============================================================================
  # E2E TESTS - Playwright browser tests (optional, runs after integration)
  # ============================================================================
  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: integration-tests
    # Only run E2E if explicitly enabled or on main branch
    if: github.ref == 'refs/heads/main' || contains(github.event.head_commit.message, '[e2e]')

    steps:
      - uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.11"
          cache: pip

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Get Playwright version
        id: playwright-version
        run: |
          VERSION=$(python -c "import playwright; print(playwright.__version__)")
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Cache Playwright browsers
        uses: actions/cache@v5
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ steps.playwright-version.outputs.version }}

      - name: Install Playwright browsers
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: python -m playwright install --with-deps chromium

      - name: Install Playwright OS dependencies
        if: steps.playwright-cache.outputs.cache-hit == 'true'
        run: python -m playwright install-deps chromium

      - name: Run E2E tests
        run: |
          pytest tests/e2e -v --tb=short \
            --run-e2e \
            --browser chromium
        env:
          CI: "true"

  # ============================================================================
  # CI SUCCESS - Summary job for branch protection
  # ============================================================================
  ci-success:
    name: CI Success
    needs: [lint, unit-tests, integration-tests]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Check all results
        run: |
          echo "Lint: ${{ needs.lint.result }}"
          echo "Unit Tests: ${{ needs.unit-tests.result }}"
          echo "Integration Tests: ${{ needs.integration-tests.result }}"

          if [[ "${{ needs.lint.result }}" != "success" ]]; then
            echo "::error::Lint checks failed"
            exit 1
          fi
          if [[ "${{ needs.unit-tests.result }}" != "success" ]]; then
            echo "::error::Unit tests failed"
            exit 1
          fi
          if [[ "${{ needs.integration-tests.result }}" != "success" ]]; then
            echo "::error::Integration tests failed"
            exit 1
          fi
          echo "All CI checks passed!"
