# Prometheus Configuration for AI Memory Module
# Comprehensive monitoring of all services in the stack
# Updated: 2026-01-26 - BUG-021 Complete monitoring coverage

global:
  scrape_interval: 15s
  evaluation_interval: 15s
  scrape_timeout: 10s

scrape_configs:
  # ===================================================================
  # Application Services (with /metrics endpoints)
  # ===================================================================

  - job_name: 'embedding-service'
    static_configs:
      - targets: ['embedding:8080']
    metrics_path: '/metrics'
    scrape_interval: 15s

  - job_name: 'ai-memory-monitoring'
    static_configs:
      - targets: ['monitoring-api:8000']
    metrics_path: '/metrics'
    scrape_interval: 15s

  # ===================================================================
  # Infrastructure Services
  # ===================================================================

  - job_name: 'qdrant'
    static_configs:
      - targets: ['qdrant:6333']
    metrics_path: '/metrics'
    scrape_interval: 15s
    # Qdrant requires API key authentication
    # NOTE: Set QDRANT_API_KEY in docker/.env - this file is a template
    # In production, use Docker Secrets or external secret management
    authorization:
      type: Bearer
      credentials_file: '/run/secrets/qdrant_api_key'

  - job_name: 'grafana'
    static_configs:
      - targets: ['grafana:3000']
    metrics_path: '/metrics'
    scrape_interval: 15s

  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']
    metrics_path: '/metrics'
    scrape_interval: 15s
    # Prometheus self-scrape with basic auth
    # NOTE: Password should be set via environment or secrets
    basic_auth:
      username: 'admin'
      password_file: '/run/secrets/prometheus_password'

  # ===================================================================
  # Pushgateway (aggregates metrics from hooks)
  # ===================================================================

  - job_name: 'pushgateway'
    honor_labels: true
    metrics_path: '/metrics'
    static_configs:
      - targets: ['pushgateway:9091']

  # ===================================================================
  # NOTES
  # ===================================================================
  #
  # classifier-worker does NOT have a /metrics endpoint
  # It's a Python script that pushes metrics to Pushgateway
  # Its metrics appear under job="ai_memory_classifier" via Pushgateway
  #
  # honor_labels: true on Pushgateway preserves job labels from pushed metrics
  # This allows classifier, hooks, etc. to maintain their own job identities
