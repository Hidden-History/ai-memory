{
  "uid": "ai-memory-performance-v2",
  "title": "AI Memory Performance",
  "tags": [
    "ai-memory",
    "memory",
    "performance",
    "v2"
  ],
  "timezone": "browser",
  "schemaVersion": 39,
  "version": 7,
  "refresh": "30s",
  "time": {
    "from": "now-1h",
    "to": "now"
  },
  "timepicker": {
    "refresh_intervals": [
      "10s",
      "30s",
      "1m",
      "5m",
      "15m"
    ]
  },
  "templating": {
    "list": [
      {
        "name": "project",
        "type": "query",
        "datasource": {
          "type": "prometheus",
          "uid": "prometheus"
        },
        "query": "label_values(aimemory_captures_total, project)",
        "refresh": 2,
        "includeAll": true,
        "allValue": ".*",
        "current": {
          "text": "All",
          "value": "$__all"
        }
      },
      {
        "name": "hook",
        "type": "custom",
        "options": [
          {
            "text": "UserPromptSubmit",
            "value": "UserPromptSubmit"
          },
          {
            "text": "Stop",
            "value": "Stop"
          },
          {
            "text": "PostToolUse",
            "value": "PostToolUse"
          },
          {
            "text": "PostToolUse_Error",
            "value": "PostToolUse_Error"
          },
          {
            "text": "PreCompact",
            "value": "PreCompact"
          },
          {
            "text": "PostToolUse_ErrorDetection",
            "value": "PostToolUse_ErrorDetection"
          },
          {
            "text": "PreToolUse_NewFile",
            "value": "PreToolUse_NewFile"
          },
          {
            "text": "PreToolUse_FirstEdit",
            "value": "PreToolUse_FirstEdit"
          },
          {
            "text": "UserPromptSubmit_Decision",
            "value": "UserPromptSubmit_Decision"
          },
          {
            "text": "UserPromptSubmit_BestPractices",
            "value": "UserPromptSubmit_BestPractices"
          },
          {
            "text": "SessionStart",
            "value": "SessionStart"
          }
        ],
        "multi": true,
        "includeAll": true,
        "current": {
          "text": "All",
          "value": [
            "$__all"
          ]
        },
        "allValue": ".*"
      },
      {
        "name": "trigger",
        "type": "custom",
        "options": [
          {
            "text": "PostToolUse_ErrorDetection",
            "value": "PostToolUse_ErrorDetection"
          },
          {
            "text": "PreToolUse_NewFile",
            "value": "PreToolUse_NewFile"
          },
          {
            "text": "PreToolUse_FirstEdit",
            "value": "PreToolUse_FirstEdit"
          },
          {
            "text": "UserPromptSubmit_Decision",
            "value": "UserPromptSubmit_Decision"
          },
          {
            "text": "UserPromptSubmit_BestPractices",
            "value": "UserPromptSubmit_BestPractices"
          },
          {
            "text": "SessionStart",
            "value": "SessionStart"
          }
        ],
        "multi": true,
        "includeAll": true,
        "current": {
          "text": "All",
          "value": [
            "$__all"
          ]
        },
        "allValue": ".*"
      },
      {
        "name": "quantile",
        "type": "custom",
        "options": [
          {
            "text": "p50",
            "value": "0.50"
          },
          {
            "text": "p95",
            "value": "0.95"
          },
          {
            "text": "p99",
            "value": "0.99"
          }
        ],
        "current": {
          "text": "p95",
          "value": "0.95"
        }
      }
    ]
  },
  "panels": [
    {
      "id": 100,
      "type": "text",
      "title": "",
      "gridPos": {
        "x": 0,
        "y": 0,
        "w": 24,
        "h": 6
      },
      "options": {
        "mode": "markdown",
        "content": "# AI Memory Performance Dashboard\n\n**Purpose:** Performance debugging - answering \"Which hooks are slow?\", \"Are we meeting NFRs?\", \"Where are bottlenecks?\"\n\n**Audience:** Engineers, Performance Debugging\n\n**NFR Thresholds:** Hook duration <500ms | Embedding <2s | Retrieval <3s | Success rate >95%\n\n\n**Template Variables:** Use dropdowns above to filter by hook or change quantile (p50/p95/p99)\n\n**Template Variables:** Use dropdowns above to filter by hook type or trigger type"
      }
    },
    {
      "id": 1,
      "type": "timeseries",
      "title": "Hook Latency (p95)",
      "description": "**Metric:** `aimemory_hook_duration_seconds_bucket`\n**Measures:** 95th percentile hook execution time by hook\n**Formula:** `histogram_quantile(0.95, sum by (le, hook_type) (aimemory_hook_duration_seconds_bucket{hook_type=~\"$hook\"}))`\n**NFR:** <500ms per BP-022 (NFR-P2)\n**Thresholds:** Green <500ms | Yellow 500-750ms | Red >750ms\n**Note:** Uses histogram_quantile with sum by (le) per BP-041\n**See:** BP-022 (NFR-P2), BP-041 (Histogram Quantiles), docs/prometheus-queries.md",
      "gridPos": {
        "x": 0,
        "y": 6,
        "w": 24,
        "h": 10
      },
      "targets": [
        {
          "expr": "histogram_quantile(0.95, sum by (le, hook_type) (aimemory_hook_duration_seconds_bucket{hook_type=~\"$hook\"}))",
          "refId": "A",
          "legendFormat": "{{hook_type}}"
        },
        {
          "expr": "vector(0.5)",
          "refId": "B",
          "legendFormat": "NFR Threshold (500ms)"
        }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "s",
          "custom": {
            "drawStyle": "line",
            "lineInterpolation": "smooth",
            "lineWidth": 2,
            "fillOpacity": 10,
            "showPoints": "never"
          },
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "value": null,
                "color": "green"
              },
              {
                "value": 0.5,
                "color": "yellow"
              },
              {
                "value": 0.75,
                "color": "red"
              }
            ]
          }
        },
        "overrides": [
          {
            "matcher": {
              "id": "byName",
              "options": "NFR Threshold (500ms)"
            },
            "properties": [
              {
                "id": "custom.lineStyle",
                "value": {
                  "dash": [
                    10,
                    10
                  ],
                  "fill": "dash"
                }
              },
              {
                "id": "color",
                "value": {
                  "mode": "fixed",
                  "fixedColor": "red"
                }
              },
              {
                "id": "custom.fillOpacity",
                "value": 0
              },
              {
                "id": "custom.lineWidth",
                "value": 2
              }
            ]
          }
        ]
      },
      "options": {
        "tooltip": {
          "mode": "multi",
          "sort": "desc"
        },
        "legend": {
          "displayMode": "table",
          "placement": "bottom",
          "calcs": [
            "mean",
            "max",
            "lastNotNull"
          ]
        }
      },
      "datasource": {
        "type": "prometheus",
        "uid": "prometheus"
      }
    },
    {
      "id": 2,
      "type": "timeseries",
      "title": "Embedding Duration (p95)",
      "description": "**Metric:** `aimemory_embedding_batch_duration_seconds_bucket` + `aimemory_embedding_realtime_duration_seconds_bucket`\n**Measures:** 95th percentile embedding generation time by mode (batch vs realtime)\n**Formula:** `histogram_quantile(0.95, sum by (le) (..._bucket))`\n**NFR:** Batch <2s, Realtime <500ms per BP-022 (NFR-P2, NFR-P6)\n**Thresholds:** Green <2s | Yellow 2-3s | Red >3s\n**See:** BP-022 (NFR-P2, NFR-P6), BP-041 (Histogram Quantiles), BP-017 (Multi-Embedding)",
      "gridPos": {
        "x": 0,
        "y": 16,
        "w": 24,
        "h": 10
      },
      "targets": [
        {
          "expr": "histogram_quantile(0.95, sum by (le) (aimemory_embedding_batch_duration_seconds_bucket))",
          "refId": "A",
          "legendFormat": "batch"
        },
        {
          "expr": "histogram_quantile(0.95, sum by (le) (aimemory_embedding_realtime_duration_seconds_bucket))",
          "refId": "B",
          "legendFormat": "realtime"
        },
        {
          "expr": "vector(2.0)",
          "refId": "C",
          "legendFormat": "NFR Threshold (2s)"
        }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "s",
          "custom": {
            "drawStyle": "line",
            "lineInterpolation": "smooth",
            "lineWidth": 2,
            "fillOpacity": 10,
            "showPoints": "never"
          },
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "value": null,
                "color": "green"
              },
              {
                "value": 2.0,
                "color": "yellow"
              },
              {
                "value": 3.0,
                "color": "red"
              }
            ]
          }
        },
        "overrides": [
          {
            "matcher": {
              "id": "byName",
              "options": "NFR Threshold (2s)"
            },
            "properties": [
              {
                "id": "custom.lineStyle",
                "value": {
                  "dash": [
                    10,
                    10
                  ],
                  "fill": "dash"
                }
              },
              {
                "id": "color",
                "value": {
                  "mode": "fixed",
                  "fixedColor": "red"
                }
              },
              {
                "id": "custom.fillOpacity",
                "value": 0
              },
              {
                "id": "custom.lineWidth",
                "value": 2
              }
            ]
          }
        ]
      },
      "options": {
        "tooltip": {
          "mode": "multi",
          "sort": "desc"
        },
        "legend": {
          "displayMode": "table",
          "placement": "bottom",
          "calcs": [
            "mean",
            "max",
            "lastNotNull"
          ]
        }
      },
      "datasource": {
        "type": "prometheus",
        "uid": "prometheus"
      }
    },
    {
      "id": 3,
      "type": "stat",
      "title": "Slowest Hook (p95)",
      "description": "**Metric:** `aimemory_hook_duration_seconds_bucket`\n**Measures:** Hook with highest p95 latency\n**Formula:** `topk(1, histogram_quantile(0.95, sum by (le, hook_type) (aimemory_hook_duration_seconds_bucket)))`\n**NFR:** <500ms per BP-022\n**Thresholds:** Green <500ms | Yellow 500-750ms | Red >750ms\n**Action:** If red, investigate hook bottlenecks\n**See:** BP-022 (NFR-P2)",
      "gridPos": {
        "x": 0,
        "y": 26,
        "w": 12,
        "h": 6
      },
      "targets": [
        {
          "expr": "topk(1, histogram_quantile(0.95, sum by (le, hook_type) (aimemory_hook_duration_seconds_bucket)))",
          "refId": "A",
          "legendFormat": "{{hook_type}}"
        }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "s",
          "decimals": 3,
          "noValue": "No data",
          "color": {
            "mode": "thresholds"
          },
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "value": null,
                "color": "#73BF69"
              },
              {
                "value": 0.5,
                "color": "#FADE2A"
              },
              {
                "value": 0.75,
                "color": "#F2495C"
              }
            ]
          }
        }
      },
      "options": {
        "reduceOptions": {
          "values": false,
          "calcs": [
            "lastNotNull"
          ]
        },
        "textMode": "value_and_name",
        "colorMode": "value",
        "graphMode": "area"
      },
      "datasource": {
        "type": "prometheus",
        "uid": "prometheus"
      }
    },
    {
      "id": 4,
      "type": "stat",
      "title": "Slowest Embedding (p95)",
      "description": "**Metric:** `aimemory_embedding_batch_duration_seconds_bucket` + `aimemory_embedding_realtime_duration_seconds_bucket`\n**Measures:** Slowest embedding mode (batch or realtime) p95 latency\n**Formula:** `max(...)`\n**NFR:** Batch <2s, Realtime <500ms per BP-022\n**Thresholds:** Green <2s | Yellow 2-3s | Red >3s\n**Action:** If red, check embedding service health\n**See:** BP-022 (NFR-P2, NFR-P6), BP-017 (Multi-Embedding)",
      "gridPos": {
        "x": 12,
        "y": 26,
        "w": 12,
        "h": 6
      },
      "targets": [
        {
          "expr": "max(histogram_quantile(0.95, sum by (le) (aimemory_embedding_batch_duration_seconds_bucket)) or histogram_quantile(0.95, sum by (le) (aimemory_embedding_realtime_duration_seconds_bucket)))",
          "refId": "A",
          "legendFormat": "slowest"
        }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "s",
          "decimals": 3,
          "noValue": "No data",
          "color": {
            "mode": "thresholds"
          },
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "value": null,
                "color": "#73BF69"
              },
              {
                "value": 2.0,
                "color": "#FADE2A"
              },
              {
                "value": 3.0,
                "color": "#F2495C"
              }
            ]
          }
        }
      },
      "options": {
        "reduceOptions": {
          "values": false,
          "calcs": [
            "lastNotNull"
          ]
        },
        "textMode": "value_and_name",
        "colorMode": "value",
        "graphMode": "area"
      },
      "datasource": {
        "type": "prometheus",
        "uid": "prometheus"
      }
    },
    {
      "id": 5,
      "type": "timeseries",
      "title": "Trigger Latency (Retrieval Operations)",
      "description": "**Metric:** `aimemory_hook_duration_seconds_bucket` (for retrieval hooks)\n**Measures:** 95th percentile latency for retrieval triggers\n**Formula:** `histogram_quantile($quantile, sum by (le, hook_type) (aimemory_hook_duration_seconds_bucket{hook_type=~\"PostToolUse_ErrorDetection|PreToolUse_NewFile|PreToolUse_FirstEdit|UserPromptSubmit_Decision|UserPromptSubmit_BestPractices|SessionStart\"}))`\n**NFR:** <3s for full retrieval operation per BP-022 (NFR-P2)\n**Thresholds:** Green <3s | Yellow 3-4.5s | Red >4.5s\n**Note:** Retrieval triggers include search + context injection\n**See:** BP-022 (NFR-P2), Core-Architecture-Principle-V2.md",
      "gridPos": {
        "x": 0,
        "y": 32,
        "w": 24,
        "h": 10
      },
      "targets": [
        {
          "expr": "histogram_quantile($quantile, sum by (le, hook_type) (aimemory_hook_duration_seconds_bucket{hook_type=~\"PostToolUse_ErrorDetection|PreToolUse_NewFile|PreToolUse_FirstEdit|UserPromptSubmit_Decision|UserPromptSubmit_BestPractices|SessionStart\"}))",
          "refId": "A",
          "legendFormat": "{{hook_type}}"
        },
        {
          "expr": "vector(3.0)",
          "refId": "B",
          "legendFormat": "NFR Threshold (3s)"
        }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "s",
          "custom": {
            "drawStyle": "line",
            "lineInterpolation": "smooth",
            "lineWidth": 2,
            "fillOpacity": 10,
            "showPoints": "never"
          },
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "value": null,
                "color": "green"
              },
              {
                "value": 3.0,
                "color": "yellow"
              },
              {
                "value": 4.5,
                "color": "red"
              }
            ]
          }
        },
        "overrides": [
          {
            "matcher": {
              "id": "byName",
              "options": "NFR Threshold (3s)"
            },
            "properties": [
              {
                "id": "custom.lineStyle",
                "value": {
                  "dash": [
                    10,
                    10
                  ],
                  "fill": "dash"
                }
              },
              {
                "id": "color",
                "value": {
                  "mode": "fixed",
                  "fixedColor": "red"
                }
              },
              {
                "id": "custom.fillOpacity",
                "value": 0
              },
              {
                "id": "custom.lineWidth",
                "value": 2
              }
            ]
          }
        ]
      },
      "options": {
        "tooltip": {
          "mode": "multi",
          "sort": "desc"
        },
        "legend": {
          "displayMode": "table",
          "placement": "bottom",
          "calcs": [
            "mean",
            "max",
            "lastNotNull"
          ]
        }
      },
      "datasource": {
        "type": "prometheus",
        "uid": "prometheus"
      }
    },
    {
      "id": 6,
      "type": "timeseries",
      "title": "Classifier Latency by Provider",
      "description": "**Metric:** `aimemory_classifier_latency_seconds_bucket`\n**Measures:** 95th percentile classification latency by provider\n**Formula:** `histogram_quantile($quantile, sum by (le, provider) (aimemory_classifier_latency_seconds_bucket))`\n**Providers:** ollama (local), openrouter (API), openai (API), claude (API)\n**Expected:** Ollama fastest (local), API providers slower (network latency)\n**Note:** Classification latency impacts hook performance if classification is synchronous\n**See:** src/memory/classifier.py, BP-041 (Histogram Quantiles)",
      "gridPos": {
        "x": 0,
        "y": 42,
        "w": 24,
        "h": 10
      },
      "targets": [
        {
          "expr": "histogram_quantile($quantile, sum by (le, provider) (aimemory_classifier_latency_seconds_bucket))",
          "refId": "A",
          "legendFormat": "{{provider}}"
        }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "s",
          "custom": {
            "drawStyle": "line",
            "lineInterpolation": "smooth",
            "lineWidth": 2,
            "fillOpacity": 10,
            "showPoints": "never"
          },
          "color": {
            "mode": "palette-classic"
          }
        }
      },
      "options": {
        "tooltip": {
          "mode": "multi",
          "sort": "desc"
        },
        "legend": {
          "displayMode": "table",
          "placement": "bottom",
          "calcs": [
            "mean",
            "max",
            "lastNotNull"
          ]
        }
      },
      "datasource": {
        "type": "prometheus",
        "uid": "prometheus"
      }
    }
  ],
  "editable": false,
  "fiscalYearStartMonth": 0,
  "graphTooltip": 1,
  "links": [],
  "liveNow": false,
  "style": "dark"
}